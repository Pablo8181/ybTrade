name: Create/upgrade BigQuery datasets & tables

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  # Standardize on US; can be overridden via repo/org variable BQ_LOCATION (e.g., EU or europe-*)
  GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
  BQ_LOCATION: ${{ vars.BQ_LOCATION || 'US' }}

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud (WIF/OIDC)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          export_default_credentials: true

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Make scripts executable
        run: chmod +x tools/bq/a01_bq_bootstrap_run.sh tools/verify/a01_verify_bq_location.sh
        shell: bash

      - name: Configure bq defaults (.bigqueryrc â†’ US)
        run: cp .bigqueryrc "$GITHUB_WORKSPACE/.bigqueryrc"
        shell: bash

      - name: Run bootstrap (location-normalized)
        env:
          PROJECT_ID: ${{ env.GCP_PROJECT }}
          BQ_LOCATION: ${{ env.BQ_LOCATION }}
          BIGQUERYRC: ${{ github.workspace }}/.bigqueryrc
        run: |
          set -euo pipefail
          : "${PROJECT_ID:?missing}"
          bash tools/bq/a01_bq_bootstrap_run.sh
        shell: bash

      - name: Verify job location
        env:
          PROJECT_ID: ${{ env.GCP_PROJECT }}
          BQ_LOCATION: ${{ env.BQ_LOCATION }}
          BIGQUERYRC: ${{ github.workspace }}/.bigqueryrc
        run: bash tools/verify/a01_verify_bq_location.sh
        shell: bash

