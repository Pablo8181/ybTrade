name: BigQuery Bootstrap

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.1.1

      - name: Set up Python
        uses: actions/setup-python@v4.7.1
        with:
          python-version: '3.11'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2.1.3
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
          create_credentials_file: true

      - name: Install BigQuery client
        run: |
          python -m pip install --upgrade pip
          python -m pip install google-cloud-bigquery

      - name: Bootstrap dataset and tables
        env:
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
        run: |
          python - <<'PY'
import os
from pathlib import Path

from google.cloud import bigquery

project = os.environ["GCP_PROJECT"].strip()
if not project:
    raise SystemExit("Missing GCP_PROJECT secret")

sql_path = Path("tools/bq/bootstrap.sql")
statements = []
for fragment in sql_path.read_text(encoding="utf-8").replace("{{PROJECT}}", project).split(";"):
    stmt = fragment.strip()
    if stmt:
        statements.append(stmt)

client = bigquery.Client(project=project)
for stmt in statements:
    job = client.query(stmt)
    job.result()
    print(f"Executed: {stmt.splitlines()[0]}")

print("Bootstrap completed successfully.")
PY
