    steps:
      - uses: actions/checkout@v4

      - name: Validate required secrets (fail early)
        run: |
          req=(WIF_PROVIDER WIF_SERVICE_ACCOUNT GCP_PROJECT GCP_REGION SHEET_ID)
          for v in "${req[@]}"; do
            if [ -z "${{ secrets.WIF_PROVIDER }}" ] && [ "$v" = "WIF_PROVIDER" ]; then echo "::error::Missing secret: WIF_PROVIDER"; exit 1; fi
            if [ -z "${{ secrets.WIF_SERVICE_ACCOUNT }}" ] && [ "$v" = "WIF_SERVICE_ACCOUNT" ]; then echo "::error::Missing secret: WIF_SERVICE_ACCOUNT"; exit 1; fi
            if [ -z "${{ secrets.GCP_PROJECT }}" ] && [ "$v" = "GCP_PROJECT" ]; then echo "::error::Missing secret: GCP_PROJECT"; exit 1; fi
            if [ -z "${{ secrets.GCP_REGION }}" ] && [ "$v" = "GCP_REGION" ]; then echo "::error::Missing secret: GCP_REGION"; exit 1; fi
            if [ -z "${{ secrets.SHEET_ID }}" ] && [ "$v" = "SHEET_ID" ]; then echo "::error::Missing secret: SHEET_ID"; exit 1; fi
          done

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install -r a_apps/a01_bsp_pullDaily_sheet_full/requirements.txt

      - name: Auth to GCP (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT }}

      - name: Build & push image
        run: |
          set -euo pipefail
          REGION="${{ secrets.GCP_REGION }}"
          PROJ="${{ secrets.GCP_PROJECT }}"
          REPO="trading"
          IMAGE="${REGION}-docker.pkg.dev/${PROJ}/${REPO}/a01_bsp_pullDaily_sheet_full:$(git rev-parse --short HEAD)"
          cat > Dockerfile <<'DOCKER'
          FROM python:3.11-slim
          WORKDIR /app
          COPY a_apps/a01_bsp_pullDaily_sheet_full/requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt
          COPY a_apps/a01_bsp_pullDaily_sheet_full/ .
          ENTRYPOINT ["python","/app/main.py"]
          DOCKER
          gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet
          docker build -t "$IMAGE" .
          docker push "$IMAGE"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Deploy Cloud Run Job
        run: |
          set -euo pipefail
          gcloud run jobs deploy a01_bsp_pullDaily_sheet_full \
            --image "$IMAGE" \
            --region "${{ secrets.GCP_REGION }}" \
            --service-account "${{ secrets.WIF_SERVICE_ACCOUNT }}" \
            --set-env-vars SHEET_ID=${{ secrets.SHEET_ID }},SHEET_TAB=spot1d,WRITE_MODE=replace \
            --set-env-vars PROVIDER=${{ github.event.inputs.provider || 'binance' }},SYMBOL=${{ github.event.inputs.symbol || 'BTCUSDT' }},SINCE=${{ github.event.inputs.since || '2017-01-01' }} \
            --max-retries 2 \
            --timeout 900s

      - name: Execute Job (wait)
        run: gcloud run jobs execute a01_bsp_pullDaily_sheet_full --region "${{ secrets.GCP_REGION }}" --wait
